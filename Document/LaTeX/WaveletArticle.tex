%
% Complete documentation on the extended LaTeX markup used for Insight
% documentation is available in ``Documenting Insight'', which is part
% of the standard documentation for Insight.  It may be found online
% at:
%
%     http://www.itk.org/

\documentclass{InsightArticle}
\usepackage[dvips]{graphicx}

\usepackage{float}
\usepackage{subcaption}
\usepackage{color}
\definecolor{mygreen}{rgb}{0,0.6,0}
\definecolor{mygray}{rgb}{0.5,0.5,0.5}
\definecolor{mymauve}{rgb}{0.58,0,0.82}
\usepackage{listings}
\lstset{language=C++,
        basicstyle=\ttfamily\footnotesize,
        keywordstyle=\color{blue},
        stringstyle=\color{mymauve},
        commentstyle=\color{mygreen},
        morecomment=[l][\color{magenta}]{\#}
}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{amsthm}
\theoremstyle{definition}
\newtheorem{definition}{Definition}[section]
\newtheorem{remark}{Remark}
\usepackage{commath} % defines abs, norm, vec, etc
\usepackage{mathtools} % complex arrows
\usepackage{bm} %easy usage of bold in math mode
\usepackage{caption} %setup of captions
\usepackage{tikz}
\usetikzlibrary{external}
%\tikzexternalize[prefix=tikz/]
% \graphicspath{ {tikz/} }
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%  hyperref should be the last package to be loaded.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage[
bookmarks,
bookmarksopen,
backref,
colorlinks,linkcolor={blue},citecolor={blue},urlcolor={blue}
]{hyperref}
%  This is a template for Papers to the Insight Journal.
%  It is comparable to a technical report format.

% The title should be descriptive enough for people to be able to find
% the relevant document.
\title{Isotropic and Steerable Wavelets in N-Dimensions. A multiresolution analysis framework.}

%
% NOTE: This is the last number of the "handle" URL that
% The Insight Journal assigns to your paper as part of the
% submission process. Please replace the number "1338" with
% the actual handle number that you get assigned.
%
\newcommand{\IJhandlerIDnumber}{3558}

% Increment the release number whenever significant changes are made.
% The author and/or editor can define 'significant' however they like.
\release{0.3}

% At minimum, give your name and an email address.  You can include a
% snail-mail address if you like.
%\href{http://www.biophysics.ac.nz/}{Biophysics Group}
\author{P. H. Cerdan $^{1,2}$}
\authoraddress{$^{1}$ Institute of Fundamental Sciences, Massey University, New Zealand\\
  $^{2}$ p.hernandezcerdan@massey.ac.nz}

\begin{document}

%
% Add hyperlink to the web location and license of the paper.
% The argument of this command is the handler identifier given
% by the Insight Journal to this paper.
%
\IJhandlefooter{\IJhandlerIDnumber}


\ifpdf
\else
   %
   % Commands for including Graphics when using latex
   %
   \DeclareGraphicsExtensions{.eps,.jpg,.gif,.tiff,.bmp,.png}
   \DeclareGraphicsRule{.jpg}{eps}{.jpg.bb}{`convert #1 eps:-}
   \DeclareGraphicsRule{.gif}{eps}{.gif.bb}{`convert #1 eps:-}
   \DeclareGraphicsRule{.tiff}{eps}{.tiff.bb}{`convert #1 eps:-}
   \DeclareGraphicsRule{.bmp}{eps}{.bmp.bb}{`convert #1 eps:-}
   \DeclareGraphicsRule{.png}{eps}{.png.bb}{`convert #1 eps:-}
\fi


\maketitle


\ifhtml
\chapter*{Front Matter\label{front}}
\fi

\begin{abstract}
\noindent
This document describes the implementation of a multiresolution analsyis framework using isotropic and steerable wavelets in the frequency domain.

It also aims to serve as an introduction to these radial wavelets, hopefully providing a bridge between introductory books and research papers on the subject.

The implementation is based on the original research made through the years by: Freeman, Adelman, Simoncelli, Kovasi, and specially on recent studies by Held, Chenouard, Van de Ville and Unser.

The backbone of the multiscale analysis is provided by the Isotropic Wavelets, and the detection of directional features is provided by coupling it with a generalized Riesz transform.
The generalized Riesz transform of order N behaves like a smoothed version of the Nth order derivatives of the signal. Also, it is steerable: its components impulse responses can be rotated to any spatial orientation.

This paper is accompanied with the source code, input data, parameters and
output data that the author used for validating the algorithm described in
this paper. This adheres to the fundamental principle that scientific
publications must facilitate reproducibility of the reported results.

\end{abstract}

\IJhandlenote{\IJhandlerIDnumber}

\tableofcontents

\section{Introduction to Wavelet decomposition}
\label{sec:Intro}
Learning about wavelets from research papers is hard. The topic is rich and deep, the same tool but with different names have span different research fields, from theoretical physics, to seismology, and signal processing.

\subsection{Motivation: spatial and frequency resolution}
\label{sub:Motivation}
Initially, wavelets share the same motivation than the short-time FFT, or the windowed Fourier transform: get a representation of the signal/image/function that is well localized in space \textbf{and} frequency domains. Heisenberg Uncertainty principle applies here and it is called the Heisenberg-Gabor limit: $\Delta t \cdot \Delta f \geq \frac{1}{4\pi}$, limiting the simultaneous resolution in time-frequency.
The Fourier transform, which is the representation of the signal in the basis of harmonic functions $\{\sin(f),\cos(f)\}\ \forall f \in \mathbb{R}$, is completely localized in frequency $\Delta f = 0$, but has global support in space, ie is infinitely delocalized in space $\Delta t = \infinity$.

A few examples to illustrate the concept: In a discrete case, such as an image, this means that the FFT has the highest resolution on frequency, but where, in the spatial domain, a specific frequency occurs is reduced to `somewhere' in the size of the image (\autoref{fig:grid_a_fft}).
Or in signals occurring only in one time lapse: they can't be differentiated from the same signal occurring continuously, so they will share the same spectrum representation. In the same line, non-stationary signals which frequency depends on time will give a spectrum where all those frequencies are represented, but there is no information about when, in time, the change of frequency occurred.  TODO: insert python graph here with a non-stationary function and same FFT.

The short-time FFT add spatial/time localization dividing the original signal in small, consecutive segments, and applying the FFT to each of those. The problem with this approach, besides being computationally expensive, is that events shorter than the time window are still not resolved and that the width of the segment is constant (\autoref{fig:grid_b_windowed}). Would it be possible to have better spatial resolution for some components of the frequency spectra, such as high frequency components (\autoref{fig:grid_c_wavelet})?

\begin{figure}[H]
  \begin{subfigure}[t]{.33\textwidth}
    \centering
    \input{tikz/freq_time_grid1.tex}
    \captionsetup{width=0.8\textwidth}
    \caption{Fourier Transform, time resolution is the duration of the signal.}
    \label{fig:grid_a_fft}
  \end{subfigure}
  \begin{subfigure}[t]{.33\textwidth}
    \centering
    \input{tikz/freq_time_grid2.tex}
    \captionsetup{width=0.8\textwidth}
    \caption{Windowed-FFT or Short-Time-FFT, fixed width window}
    \label{fig:grid_b_windowed}
  \end{subfigure}
  \begin{subfigure}[t]{.33\textwidth}
    \centering
    \input{tikz/freq_time_grid3.tex}
    \captionsetup{width=0.8\textwidth}
    \caption{Discrete Wavelet Transform. Adaptive window, better time resolution at high frequencies.}
    \label{fig:grid_c_wavelet}
  \end{subfigure}
  \caption{Simultaneous spatial and frequency resolution of different transformations. $\Delta t, \Delta f$}
  \label{fig:grids}
\end{figure}

\subsection{Dilation and translation operators}
The wavelet transform is a translation of a dilation on a function $\psi$, that it is called the mother wavelet. Each dilation change of scale. The wavelet coefficient at each scale, and translation is:
\begin{equation}
  \psi_{s,l}(\bm{x}) = \text{det}|\bm{A}|^{-1/2}\psi(\bm{A}^s\bm{x} - \bm{l})
\end{equation}

\begin{definition}
  Given a function $f \in \mathbb{R}$ we define the following operators. From \cite{heil_continuous_1989} \par
  \begin{tabular}{lll}
    Dilation:&  $D_a f(x):=\abs{a}^{-1/2}f(x/a)$ &for $a \in \mathbb{R}\backslash\{0\}$ \\
    Translation:&   $T_b f(x):=f(x-b)$ &for $b \in \mathbb{R}$ \\
  \end{tabular}
\end{definition}

\begin{definition}[$\mathbb{R}^n$]
  Given $f \in \mathcal{L}^2(\mathbb{R}^n), f:\mathbb{R}^n \rightarrow \mathbb{R}$, $\bm{x}\in\mathbb{R}^n$, the dilation scalar $a$ is replaced by a dilation matrix $\bm{A} = \bm{a} \bm{I}_n$. The dilation matrix $\bm{A}$ is expansive, having all its eigenvalues $\abs{\lambda_i} > 1$, so it is invertible. For the translation operator, the scalar $b$ is replaced for the vector $\bm{b}$.\\
  \begin{tabular}{lll}
    Dilation:& $D_a f(\bm{x}):=\text{det}|\bm{A}|^{-1/2}f(\bm{A}\bm{x})$ &$\bm{A} \text{ expansive matrix}$\\
    Translation:&   $T_b f(\bm{x}):=f(\bm{x}-\bm{b})$ &for $\bm{b} \in \mathbb{R}^n$ \\
  \end{tabular}
\end{definition}

\section{Wavelet transformation}
Motivation: Fourier and Windowed Fourier. Heisenberg.
\begin{enumerate}
  \item Dilation Equation. Operator D
  \item Operator T. Translation.
  \item Wavelet Coefficients, basis, orthonormal, frames, oversample
  \item Multiscale methods, pyramid, Meyer. Analysis and reconstruction.
\end{enumerate}

\section{Isotropic wavelets}
\label{sub:Isotropic}
These wavelets are non-separable, depending on $\norm{\bm{\omega}}$. Isotropic wavelets has the same mother wavelet for each scale. In order to analyze the directionality features, the filter bank of the wavelets is convolved with other filters that gather directional information. For example the Riesz transform, see Section \ref{sec:Riesz}.

\subsection{Isotropic wavelets: implemented}
\noindent\begin{minipage}[t]{0.49\textwidth}
  \textbf{VOW}, variance-optimal wavelets \cite{pad_vow:_2014} :
\begin{equation*}
\label{VOW}
  h(\omega) =
    \begin{cases}
    \begin{aligned}
      &\sqrt{\frac{1}{2} + \frac{\tan(\kappa(1+2\log_2\frac{2\omega}{\pi}))}{2\tan(\kappa)}} , &\omega \in [\frac{\pi}{4} , \frac{\pi}{2} [ \\
      &\sqrt{\frac{1}{2} - \frac{\tan(\kappa(1+2\log_2\frac{\omega}{\pi}))}{2\tan(\kappa)}} , &\omega \in [\frac{\pi}{2} , \pi ] \\
      &0, &\text{otherwise}
    \end{aligned}
    \end{cases}
\end{equation*}
\begin{equation*}
  \text{where } \kappa \in [0, \frac{\pi}{2}] \text{ is found to be } 0.75
\end{equation*}
\newline
\end{minipage}
\noindent\begin{minipage}[t]{0.49\textwidth}
  \textbf{Held} \cite{held_steerable_2010} :
\begin{equation*}
\label{Held}
  h(\omega) =
    \begin{cases}
    \begin{aligned}
&\cos\left(2\pi q_n(\frac{\omega}{2\pi})\right) , &\omega \in ]\frac{\pi}{4} , \frac{\pi}{2} ] \\
  &\sin\left(2\pi q_n(\frac{\omega}{4\pi})\right) , &\omega \in ]\frac{\pi}{2} , \pi ] \\
      &0, &\text{otherwise}
    \end{aligned}
    \end{cases}
\end{equation*}
\begin{equation*}
  \text{where } q_n \text{ is a polynomial function of order n } %TODO q
\end{equation*}
\end{minipage}
\noindent\begin{minipage}[t]{0.49\textwidth}
  \textbf{Simoncelli} \cite{portilla_image_2000, simoncelli_steerable_1995} :
\begin{equation*}
\label{Simoncelli}
  h(\omega) =
    \begin{cases}
    \begin{aligned}
  &\cos\left(\frac{\pi}{2} \log_2\frac{2\omega}{\pi}\right) , &\omega \in ]\frac{\pi}{4} , \frac{\pi}{2} ] \\
  &0, &\text{otherwise}
    \end{aligned}
    \end{cases}
\end{equation*}
\end{minipage}
\noindent\begin{minipage}[t]{0.49\textwidth}
\textbf{Shannon:}
\begin{equation*}
\label{Shannon}
  h(\omega) =
    \begin{cases}
    \begin{aligned}
  &1, &\omega \in [\frac{\pi}{2} , \pi ] \\
  &0, &\text{otherwise}
    \end{aligned}
    \end{cases}
\end{equation*}
\end{minipage}
% \section{Testing listing}
% HOLAAA
% \begin{lstlisting}
% #include <iostream>
% // A comment
% int main()
% {
%    std::cout << "Hola" << '\n';
%    return 0;
%
% }
% \end{lstlisting}

\section{Multiscale Phase Analyis with the Riesz transform: A generalization of the Hilbert transform}
\label{sec:Riesz}
The forward or analysis wavelet pyramid outputs a set of wavelet coefficients with information about each scale.
A steerable filter \cite{held_steerable_2010, unser_steerable_2011, simoncelli_steerable_1995} can be applied to the output of the wavelet pyramid. This is the main purpose of the isotropy of the mother wavelet, the steerable filter is used to select the orientation where the feature of interest is maximum.

There are mathematical constraints in the steerable filters that can be coupled with the wavelet pyramid. Read more: \cite{unser_multiresolution_2009, unser_steerable_2011}.

One of the transform that can be coupled to the pyramid is the Riesz transform $\bm{\mathcal{R}}$
\begin{equation}
\bm{\mathcal{R}} f(\bm{x}) =
  \begin{pmatrix}
    \mathcal{R}_{1} f(\bm{x}) \\
    \vdots \\
    \mathcal{R}_D f(\bm{x})
  \end{pmatrix}
  \hspace{0.6cm}
  \xleftrightarrow[\mathcal{F}^{-1}]{\hspace{0.4cm}\mathcal{F}\hspace{0.4cm}}
  \hspace{0.6cm}
  \bm{\hat{\mathcal{R}}}\hat{f}(\bm{\omega}) = -j \frac{\bm{\omega}}{\norm{\bm{\omega}}}\hat{f}(\bm{\omega})
\end{equation}
where D is the image dimension, $j=\sqrt{-1}$ and $\mathcal{F}, \mathcal{F}^{-1}$ are the forward and inverse Fourier Transform.
The Riesz transform is the generalization of the Hilbert transform, which is the case for $D=1$. The Hilbert transform $\mathcal{H}$ is used to generate the \textit{analytic signal} in 1D, which is the base to perform phase analysis of the original signal.
\begin{equation}
\label{eq:analytic-signal}
\begin{aligned}
  f_a(x) &= f(x) + j \mathcal{H}f(x) \\
  \mathcal{H}f(x) = (h * f)(x)
  \hspace{0.6cm}
  &\xleftrightarrow[\mathcal{F}^{-1}]{\hspace{0.4cm}\mathcal{F}\hspace{0.4cm}}
  \hspace{0.6cm}
  \hat{\mathcal{H}}\hat{f}(\omega) = -jsgn(\omega)\hat{f}(\omega) = -j \frac{\omega}{\abs{\omega}}\hat{f}(\omega)
\end{aligned}
\end{equation}

The same approach is used in ND using the Riesz transform in every dimension.
The analogous to the analytical signal is now a D+1 set called the \textbf{Monogenic signal}\cite{felsberg_monogenic_2001, kovesi_peters_????}.
\begin{equation}
  f_m = \{f, \mathcal{R}_1, ..., \mathcal{R}_D\}
\end{equation}

\subsection{Generalized Riesz Transform}
The Riesz transform will map any frame of $L_2(\mathbb{R}^d)$ into another one \cite{held_steerable_2010, unser_wavelet_2010}.\\
\begin{definition}[Frame]
  A frame of $L_2(\mathbb{R}^d)$ is a family of functions $\{\phi_{\bm{k}}\}_{ \bm{k}\in\mathbb{Z}^d}$ if and only if there exists two positive constants A, B $< \infinity$ such that:

\begin{equation}
  \forall f \in L_2(\mathbb{R}^d), A\norm{f}^2 \le \sum_{\bm{k}\in\mathbb{Z}^d}\abs{\langle\phi_{\bm{k}},f\rangle}^2 \le B\norm{f}^2
\end{equation}

The frame is \textit{tight} if $A=B$. If $A=B=1$ we have a \textit{Parseval frame} that satisfies the decomposition/reconstruction formula:
\begin{equation}
  \forall f \in L_2(\mathbb{R}^d), f = \sum_{\bm{k}\in\mathbb{Z}^d}\langle\phi_{\bm{k}},f\rangle \cdot \phi_{\bm{k}}
\end{equation}
which has the same form than the expansion using an orthonormal basis, however in the frame generalization, the family $\phi_{\bm{k}}$ may be redundant.
\end{definition}

\subsection{Generalized Steerable Framework}
Simoncelli \cite{simoncelli_steerable_1995} coupled the multiresolution analysis using wavelets with the steerable concept developed years before \cite{freeman_design_1991}. A steerable framework can be used with polar separable functions. In this case, the radial part of the function has to be calculated only once, and the polar part has only to be computed in those directions that constitute a basis of the space. After this, the filter can be oriented, or steered to any direction, using a weighted linear combination of the basis. This approach gives a directional analysis but keeping it computationally performant.

The steerable framework can be combined with wavelets when these are isotropic, which implies polar separability.
Simoncelli's framework has been used in a lot of 2D applications. Chenouard, Unser \cite{held_steerable_2010,unser_steerable_2011,chenouard_3d_2012} proposed a generalization to 3D of the steerable framework using rotation matrices.

\begin{definition}
A function $f$ is steerable in three dimensions if it can be expressed as:
\begin{equation}
  f(\bm{Rx}) = \sum_{m=1}^M k_m(\bm{R})g_m(\bm{x})
\end{equation}
where $\bm{x} = (x_1,x_2,x_3)$ is any 3D vector in Cartesian coordinates and $\bm{R}$ is any rotation matrix in three dimensions.
$\{g_m\}_{m=1...M}$ is the set of primary functions, ie , a basis, and $\{k_m\}_{m=1...M}$ is a set of interpolation functions with $M < \infinity$.
\end{definition}

\section{Implementation Details}
\label{sec:Impl}
\subsection{Summary}
\label{sub:Summary}

Input to filters in this module needs to be in the dual space (frequency). Usually from the output of a forward FFT \doxygen{ForwardFFTImageFilter} The decision is based on performance and accuracy, avoiding expensive convolution operations.

Also because we work in the frequency space, we add a \doxygen{FrequencyShrinker} and a \doxygen{FrequencyExpander} \textbf{without} any interpolation. The shrinker chops the high frequency pixels of the image. And the expander adds zeros in the higher frequency bins. Also note that these filters don't assume that the complex input is hermitian, so they can be used with any complex input not necessarily derived from a real space image.

Every filter that uses the frequency value of a pixel can be templated with a \doxygen{FrequencyImageRegionIterator}.\newline
This iterator just add  a method \lstinline[columns=fixed]{GetFrequencyIndex()} to a regular \doxygen{ImageRegionIterator}, helping to abstract any complexity about the frequency layout into the iterator. By layout meaning the index of the pixels storing the value of the DC component (0 frequency), low/high frequency regions, or highest/Nyquist frequency. Also this layout can change depending on the parity of the image, or the library chosen to perform the Fourier Transform. For example, the python package performing a FFT generate a different frequency layout than the same transform from VNL or FFTW libraries. Even when the results are equivalent. At the time of writing, a frequency iterator for the layout of the FFTW library has been added. (TODO: VNL might share the same layout than FFTW but further testing or confirmation is required).\newline
This abstraction will hopefully facilitate the implementation of further filters manipulating images in the frequency domain.

The next section deals with the Wavelet Pyramid that generates wavelet coefficients for each level (equal to the number of M-bands per level, more later).  The pyramid is redundant, and perfect reconstruction of the original input can be achieved using the inverse Wavelet transform.

The Wavelet Transform is templated over an IsotropicWavelet chosen by the user through a \doxygen{WaveletFilterBankGenerator}

The wavelet coefficients from the forward pyramid can be manipulated to perform further image analysis, for example edge detection, denoise, phase analysis for feature detection, etc.

This module also implements a couple of PhaseAnalyzers that can be used on every wavelet coefficient to perform multi-scale feature detection. It is based on the Riesz Transform and the Monogenic Signal \cite{felsberg_monogenic_2001,unser_multiresolution_2009}.
One of the phase analyzer use the steerability of the Riesz transform to select the orientation of max response \cite{held_steerable_2010,unser_steerable_2011}.

\section{A guided example:}
I recommend the reader interested in extend this module to have a look to the tests for more usage options.
\subsection{Input in the frequency space.}
The input for the \doxygen{WaveletFrequencyForward} has to be a complex image of float pixel type. If the input is a real image, this representation is generated from a forward FFT , \doxygen{ForwardFFTImageFilter}.
Perform an FFT. Select of the layout.
Problems with FFTPad, negative index does not work well with neighbour iterators. Solvable.
\subsection{Choosing an isotropic wavelet}
\label{sub:Choosing}
Through a WaveletFilterBankGenerator. See available options \ref{sub:Isotropic}
Note that the frequency input must be in Hz, not in rad/sec. A method: TODOTODODO
All the isotropic wavelets developed form a frame with tight support (?), but their wavelet basis might not be orthogonal, and the span of the basis is usually oversampled. (TODOTODO Check this.)
\subsection{Wavelet Pyramid}
\label{sub:Pyramid}

\subsection{Forward / Analysis}
\label{sub:Forward}

\subsection{PhaseAnalyzer}

\subsection{Inverse / Reconstruction}
\label{sub:Inverse}

% The preceding sections will have been written in a gentler,
% introductory style.  You may also wish to include a reference
% section, documenting all the functions/exceptions/constants.
% Often, these will be placed in separate files and input like this:

\appendix

\section{This is an Appendix}

To create an appendix in a Insight HOWTO document, use markup like
this:

\begin{verbatim}
\appendix

\section{This is an Appendix}

To create an appendix in a Insight HOWTO document, ....


\section{This is another}

Just add another \section{}, but don't say \appendix again.
\end{verbatim}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%  Example on how to insert a figure
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%  Example on how to insert an equation.
%  Never forget to put an equation in your paper.
%  They make them look professional and impress the reviewers.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


To support shape-guidance, the generic level set equation
(Eqn(~\ref{eqn:ShapeInfluenceTerm})) is extended to incorporate a shape guidance
term:

\begin{equation}
\label{eqn:ShapeInfluenceTerm}
\xi \left(\psi^{*}(\mathbf{x}) - \psi(\mathbf{x})\right)
\end{equation}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%  Insert the bibliography using BibTeX
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\nocite{*} % Print all bib.
\bibliographystyle{unsrt}
\twocolumn
\bibliography{Wavelet}
\onecolumn


\end{document}
